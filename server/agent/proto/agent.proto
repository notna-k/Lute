syntax = "proto3";

package agent;

option go_package = "github.com/lute/agent/proto/agent";

// AgentService â€” a single bidirectional stream between agent and API server.
// The agent opens the stream after REST registration; the API sends heartbeat
// pings and the agent responds with pongs carrying status and metrics.
service AgentService {
  rpc Connect(stream AgentMessage) returns (stream ServerMessage);
}

message AgentMessage {
  string machine_id = 1;
  oneof payload {
    HeartbeatPong heartbeat_pong = 2;
  }
}

message ServerMessage {
  oneof payload {
    HeartbeatPing heartbeat_ping = 1;
  }
}

message HeartbeatPing {
  int64 timestamp = 1;
}

// MetricValue holds a single metric as an integer, float, or string.
message MetricValue {
  oneof kind {
    int64 i = 1;
    double f = 2;
    string s = 3;
  }
}

message HeartbeatPong {
  string status = 1;
  map<string, MetricValue> metrics = 2;
  int64 timestamp = 3;
}
